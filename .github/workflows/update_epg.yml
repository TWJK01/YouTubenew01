name: Auto Update EPG

# 設定觸發條件
on:
  schedule:
    # 每天台北時間 (GMT+8) 凌晨 04:00 執行一次 (UTC 20:00)
    - cron: '0 20 * * *'
  workflow_dispatch: # 允許在 GitHub 頁面上手動點擊 "Run workflow" 觸發

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 賦予 Actions 寫入權限，否則無法 Git Push
    permissions:
      contents: write

    steps:
      - name: 1. 檢出儲存庫代碼
        uses: actions/checkout@v4

      - name: 2. 設定 Python 環境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # 刪除 cache: 'pip' 這行

      - name: 3. 安裝必要依賴
        run: |
          python -m pip install --upgrade pip
          pip install requests lxml

      - name: 4. 執行抓取腳本
        run: python grabber.py

      - name: 5. 檢查檔案並提交更新
        run: |
          # 設定 Git 使用者資訊
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 檢查 epg.xml 是否存在且檔案大小大於 200 bytes (確保不是只有空標籤)
          if [ -f "epg.xml" ] && [ $(stat -c%s "epg.xml") -gt 200 ]; then
            git add epg.xml
            # 只有在檔案內容有變動時才 commit
            if ! git diff --cached --quiet; then
              git commit -m "chore: 自動更新節目表 $(date +'%Y-%m-%d %H:%M')"
              git push
              echo "EPG 更新成功並已推送到儲存庫。"
            else
              echo "EPG 內容無變動，跳過提交。"
            fi
          else
            echo "錯誤：生成的 epg.xml 無效或太小，請檢查爬蟲日誌。"
            exit 1
          fi
